# Test Configuration - Uses Docker Compose Infrastructure
#
# IMPORTANT: Before running tests, ensure Docker Compose infrastructure is running:
#   make start
#
# This configuration connects to the local Docker Compose PostgreSQL instance
# instead of using Testcontainers.

spring:
  application:
    name: cqrs-spike-test

  # Increase buffer size for large Prometheus metrics responses
  codec:
    max-in-memory-size: 5MB

  # Disable Vault for tests - use static configuration
  cloud:
    vault:
      enabled: false

  # R2DBC Configuration - Connect to Docker Compose PostgreSQL
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/cqrs_db
    username: cqrs_user
    password: local_dev_password
    pool:
      initial-size: 5
      max-size: 10
      max-idle-time: 10m
      validation-query: SELECT 1

  # JDBC DataSource - Connect to Docker Compose PostgreSQL
  datasource:
    url: jdbc:postgresql://localhost:5432/cqrs_db
    username: cqrs_user
    password: local_dev_password
    driver-class-name: org.postgresql.Driver
    hikari:
      pool-name: TestHikariPool
      maximum-pool-size: 5
      minimum-idle: 2
      connection-timeout: 10000

  # Flyway - Disabled for tests, schema managed separately
  flyway:
    enabled: false

# Enable projection auto-start for acceptance tests to populate read model
projection:
  auto-start: true

# Logging - reduced verbosity for tests
logging:
  level:
    root: WARN
    com.pintailconsultingllc.cqrsspike: INFO
    org.springframework.r2dbc: WARN

# Actuator - expose endpoints needed for observability tests
management:
  endpoints:
    web:
      exposure:
        include: health,prometheus,metrics,info
  endpoint:
    health:
      show-details: always
  tracing:
    sampling:
      probability: 0.0  # Disable tracing in tests

# Resilience4j - Relaxed settings for testing
# Disable circuit breakers and rate limiters to prevent test interference
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: false
        slidingWindowSize: 100
        minimumNumberOfCalls: 100
        permittedNumberOfCallsInHalfOpenState: 50
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 1s
        failureRateThreshold: 100
        recordExceptions: []
    instances:
      productCommands:
        baseConfig: default
      productQueries:
        baseConfig: default
  retry:
    configs:
      default:
        maxAttempts: 1
        waitDuration: 10ms
        retryExceptions: []
    instances:
      productCommands:
        baseConfig: default
      productQueries:
        baseConfig: default
  ratelimiter:
    configs:
      default:
        limitForPeriod: 10000
        limitRefreshPeriod: 1s
        timeoutDuration: 60s
        registerHealthIndicator: false
    instances:
      productCommands:
        baseConfig: default
      productQueries:
        baseConfig: default
